(function(a){(function(b,c){if(typeof define==="function"&&define.amd){define("strophe-base64",function(){return c()})}else{b.Base64=c()}}(this,function(){var b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var c={encode:function(f){var d="";var n,l,j;var m,k,h,g;var e=0;do{n=f.charCodeAt(e++);l=f.charCodeAt(e++);j=f.charCodeAt(e++);m=n>>2;k=((n&3)<<4)|(l>>4);h=((l&15)<<2)|(j>>6);g=j&63;if(isNaN(l)){k=((n&3)<<4);h=g=64}else{if(isNaN(j)){g=64}}d=d+b.charAt(m)+b.charAt(k)+b.charAt(h)+b.charAt(g)}while(e<f.length);return d},decode:function(f){var d="";var n,l,j;var m,k,h,g;var e=0;f=f.replace(/[^A-Za-z0-9\+\/\=]/g,"");do{m=b.indexOf(f.charAt(e++));k=b.indexOf(f.charAt(e++));h=b.indexOf(f.charAt(e++));g=b.indexOf(f.charAt(e++));n=(m<<2)|(k>>4);l=((k&15)<<4)|(h>>2);j=((h&3)<<6)|g;d=d+String.fromCharCode(n);if(h!=64){d=d+String.fromCharCode(l)}if(g!=64){d=d+String.fromCharCode(j)}}while(e<f.length);return d}};return c}));(function(b,c){if(typeof define==="function"&&define.amd){define("strophe-sha1",function(){return c()})}else{b.SHA1=c()}}(this,function(){function d(A,r){A[r>>5]|=128<<(24-r%32);A[((r+64>>9)<<4)+15]=r;var B=new Array(80);var z=1732584193;var y=-271733879;var v=-1732584194;var u=271733878;var s=-1009589776;var o,m,C,q,p,n,l,k;for(o=0;o<A.length;o+=16){q=z;p=y;n=v;l=u;k=s;for(m=0;m<80;m++){if(m<16){B[m]=A[o+m]}else{B[m]=f(B[m-3]^B[m-8]^B[m-14]^B[m-16],1)}C=g(g(f(z,5),b(m,y,v,u)),g(g(s,B[m]),e(m)));s=u;u=v;v=f(y,30);y=z;z=C}z=g(z,q);y=g(y,p);v=g(v,n);u=g(u,l);s=g(s,k)}return[z,y,v,u,s]}function b(l,k,n,m){if(l<20){return(k&n)|((~k)&m)}if(l<40){return k^n^m}if(l<60){return(k&n)|(k&m)|(n&m)}return k^n^m}function e(k){return(k<20)?1518500249:(k<40)?1859775393:(k<60)?-1894007588:-899497514}function j(m,p){var o=h(m);if(o.length>16){o=d(o,m.length*8)}var k=new Array(16),n=new Array(16);for(var l=0;l<16;l++){k[l]=o[l]^909522486;n[l]=o[l]^1549556828}var q=d(k.concat(h(p)),512+p.length*8);return d(n.concat(q),512+160)}function g(k,n){var m=(k&65535)+(n&65535);var l=(k>>16)+(n>>16)+(m>>16);return(l<<16)|(m&65535)}function f(k,l){return(k<<l)|(k>>>(32-l))}function h(n){var m=[];var k=255;for(var l=0;l<n.length*8;l+=8){m[l>>5]|=(n.charCodeAt(l/8)&k)<<(24-l%32)}return m}function c(m){var n="";var k=255;for(var l=0;l<m.length*32;l+=8){n+=String.fromCharCode((m[l>>5]>>>(24-l%32))&k)}return n}function i(n){var m="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var p="";var o,k;for(var l=0;l<n.length*4;l+=3){o=(((n[l>>2]>>8*(3-l%4))&255)<<16)|(((n[l+1>>2]>>8*(3-(l+1)%4))&255)<<8)|((n[l+2>>2]>>8*(3-(l+2)%4))&255);for(k=0;k<4;k++){if(l*8+k*6>n.length*32){p+="="}else{p+=m.charAt((o>>6*(3-k))&63)}}}return p}return{b64_hmac_sha1:function(k,l){return i(j(k,l))},b64_sha1:function(k){return i(d(h(k),k.length*8))},binb2str:c,core_hmac_sha1:j,str_hmac_sha1:function(k,l){return c(j(k,l))},str_sha1:function(k){return c(d(h(k),k.length*8))}}}));(function(b,c){if(typeof define==="function"&&define.amd){define("strophe-md5",function(){return c()})}else{b.MD5=c()}}(this,function(l){var j=function(b,r){var q=(b&65535)+(r&65535);var p=(b>>16)+(r>>16)+(q>>16);return(p<<16)|(q&65535)};var n=function(b,p){return(b<<p)|(b>>>(32-p))};var c=function(q){var p=[];for(var b=0;b<q.length*8;b+=8){p[b>>5]|=(q.charCodeAt(b/8)&255)<<(b%32)}return p};var g=function(p){var q="";for(var b=0;b<p.length*32;b+=8){q+=String.fromCharCode((p[b>>5]>>>(b%32))&255)}return q};var o=function(q){var p="0123456789abcdef";var r="";for(var b=0;b<q.length*4;b++){r+=p.charAt((q[b>>2]>>((b%4)*8+4))&15)+p.charAt((q[b>>2]>>((b%4)*8))&15)}return r};var e=function(y,u,r,p,w,v){return j(n(j(j(u,y),j(p,v)),w),r)};var k=function(r,q,y,w,p,v,u){return e((q&y)|((~q)&w),r,q,p,v,u)};var d=function(r,q,y,w,p,v,u){return e((q&w)|(y&(~w)),r,q,p,v,u)};var m=function(r,q,y,w,p,v,u){return e(q^y^w,r,q,p,v,u)};var i=function(r,q,y,w,p,v,u){return e(y^(q|(~w)),r,q,p,v,u)};var f=function(A,u){A[u>>5]|=128<<((u)%32);A[(((u+64)>>>9)<<4)+14]=u;var z=1732584193;var y=-271733879;var w=-1732584194;var v=271733878;var t,s,r,p;for(var q=0;q<A.length;q+=16){t=z;s=y;r=w;p=v;z=k(z,y,w,v,A[q+0],7,-680876936);v=k(v,z,y,w,A[q+1],12,-389564586);w=k(w,v,z,y,A[q+2],17,606105819);y=k(y,w,v,z,A[q+3],22,-1044525330);z=k(z,y,w,v,A[q+4],7,-176418897);v=k(v,z,y,w,A[q+5],12,1200080426);w=k(w,v,z,y,A[q+6],17,-1473231341);y=k(y,w,v,z,A[q+7],22,-45705983);z=k(z,y,w,v,A[q+8],7,1770035416);v=k(v,z,y,w,A[q+9],12,-1958414417);w=k(w,v,z,y,A[q+10],17,-42063);y=k(y,w,v,z,A[q+11],22,-1990404162);z=k(z,y,w,v,A[q+12],7,1804603682);v=k(v,z,y,w,A[q+13],12,-40341101);w=k(w,v,z,y,A[q+14],17,-1502002290);y=k(y,w,v,z,A[q+15],22,1236535329);z=d(z,y,w,v,A[q+1],5,-165796510);v=d(v,z,y,w,A[q+6],9,-1069501632);w=d(w,v,z,y,A[q+11],14,643717713);y=d(y,w,v,z,A[q+0],20,-373897302);z=d(z,y,w,v,A[q+5],5,-701558691);v=d(v,z,y,w,A[q+10],9,38016083);w=d(w,v,z,y,A[q+15],14,-660478335);y=d(y,w,v,z,A[q+4],20,-405537848);z=d(z,y,w,v,A[q+9],5,568446438);v=d(v,z,y,w,A[q+14],9,-1019803690);w=d(w,v,z,y,A[q+3],14,-187363961);y=d(y,w,v,z,A[q+8],20,1163531501);z=d(z,y,w,v,A[q+13],5,-1444681467);v=d(v,z,y,w,A[q+2],9,-51403784);w=d(w,v,z,y,A[q+7],14,1735328473);y=d(y,w,v,z,A[q+12],20,-1926607734);z=m(z,y,w,v,A[q+5],4,-378558);v=m(v,z,y,w,A[q+8],11,-2022574463);w=m(w,v,z,y,A[q+11],16,1839030562);y=m(y,w,v,z,A[q+14],23,-35309556);z=m(z,y,w,v,A[q+1],4,-1530992060);v=m(v,z,y,w,A[q+4],11,1272893353);w=m(w,v,z,y,A[q+7],16,-155497632);y=m(y,w,v,z,A[q+10],23,-1094730640);z=m(z,y,w,v,A[q+13],4,681279174);v=m(v,z,y,w,A[q+0],11,-358537222);w=m(w,v,z,y,A[q+3],16,-722521979);y=m(y,w,v,z,A[q+6],23,76029189);z=m(z,y,w,v,A[q+9],4,-640364487);v=m(v,z,y,w,A[q+12],11,-421815835);w=m(w,v,z,y,A[q+15],16,530742520);y=m(y,w,v,z,A[q+2],23,-995338651);z=i(z,y,w,v,A[q+0],6,-198630844);v=i(v,z,y,w,A[q+7],10,1126891415);w=i(w,v,z,y,A[q+14],15,-1416354905);y=i(y,w,v,z,A[q+5],21,-57434055);z=i(z,y,w,v,A[q+12],6,1700485571);v=i(v,z,y,w,A[q+3],10,-1894986606);w=i(w,v,z,y,A[q+10],15,-1051523);y=i(y,w,v,z,A[q+1],21,-2054922799);z=i(z,y,w,v,A[q+8],6,1873313359);v=i(v,z,y,w,A[q+15],10,-30611744);w=i(w,v,z,y,A[q+6],15,-1560198380);y=i(y,w,v,z,A[q+13],21,1309151649);z=i(z,y,w,v,A[q+4],6,-145523070);v=i(v,z,y,w,A[q+11],10,-1120210379);w=i(w,v,z,y,A[q+2],15,718787259);y=i(y,w,v,z,A[q+9],21,-343485551);z=j(z,t);y=j(y,s);w=j(w,r);v=j(v,p)}return[z,y,w,v]};var h={hexdigest:function(b){return o(f(c(b),b.length*8))},hash:function(b){return g(f(c(b),b.length*8))}};return h}));if(!Function.prototype.stropheBind){Function.prototype.stropheBind=function(f){var e=this;var d=Array.prototype.slice;var c=Array.prototype.concat;var b=d.call(arguments,1);return function(){return e.apply(f?f:this,c.call(b,d.call(arguments,0)))}}}if(!Array.isArray){Array.isArray=function(b){return Object.prototype.toString.call(b)==="[object Array]"}}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(c){var b=this.length;var d=Number(arguments[1])||0;d=(d<0)?Math.ceil(d):Math.floor(d);if(d<0){d+=b}for(;d<b;d++){if(d in this&&this[d]===c){return d}}return -1}}(function(b,c){if(typeof define==="function"&&define.amd){define("strophe-core",["strophe-sha1","strophe-base64","strophe-md5"],function(){return c.apply(this,arguments)})}else{var d=c(b.SHA1,b.Base64,b.MD5);window.Strophe=d.Strophe;window.$build=d.$build;window.$iq=d.$iq;window.$msg=d.$msg;window.$pres=d.$pres;window.SHA1=d.SHA1;window.Base64=d.Base64;window.MD5=d.MD5;window.b64_hmac_sha1=d.SHA1.b64_hmac_sha1;window.b64_sha1=d.SHA1.b64_sha1;window.str_hmac_sha1=d.SHA1.str_hmac_sha1;window.str_sha1=d.SHA1.str_sha1}}(this,function(e,i,d){var h;function f(k,j){return new h.Builder(k,j)}function b(j){return new h.Builder("message",j)}function g(j){return new h.Builder("iq",j)}function c(j){return new h.Builder("presence",j)}h={VERSION:"1.2.2",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",FRAMING:"urn:ietf:params:xml:ns:xmpp-framing",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:["a","blockquote","br","cite","em","img","li","ol","p","span","strong","ul","body"],attributes:{a:["href"],blockquote:["style"],br:[],cite:["style"],em:[],img:["src","alt","style","height","width"],li:["style"],ol:["style"],p:["style"],span:["style"],strong:[],ul:["style"],body:[]},css:["background-color","color","font-family","font-size","font-style","font-weight","margin-left","margin-right","text-align","text-decoration"],validTag:function(j){for(var k=0;k<h.XHTML.tags.length;k++){if(j==h.XHTML.tags[k]){return true}}return false},validAttribute:function(j,l){if(typeof h.XHTML.attributes[j]!=="undefined"&&h.XHTML.attributes[j].length>0){for(var k=0;k<h.XHTML.attributes[j].length;k++){if(l==h.XHTML.attributes[j][k]){return true}}}return false},validCSS:function(k){for(var j=0;j<h.XHTML.css.length;j++){if(k==h.XHTML.css[j]){return true}}return false}},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8,REDIRECT:9},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:0.1,addNamespace:function(j,k){h.NS[j]=k},forEachChild:function(m,n,l){var k,j;for(k=0;k<m.childNodes.length;k++){j=m.childNodes[k];if(j.nodeType==h.ElementType.NORMAL&&(!n||this.isTagEqual(j,n))){l(j)}}},isTagEqual:function(k,j){return k.tagName==j},_xmlGenerator:null,_makeGenerator:function(){var j;if(document.implementation.createDocument===undefined||document.implementation.createDocument&&document.documentMode&&document.documentMode<10){j=this._getIEXmlDom();j.appendChild(j.createElement("strophe"))}else{j=document.implementation.createDocument("jabber:client","strophe",null)}return j},xmlGenerator:function(){if(!h._xmlGenerator){h._xmlGenerator=h._makeGenerator()}return h._xmlGenerator},_getIEXmlDom:function(){var k=null;var m=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"];for(var l=0;l<m.length;l++){if(k===null){try{k=new ActiveXObject(m[l])}catch(j){k=null}}else{break}}return k},xmlElement:function(o){if(!o){return null}var q=h.xmlGenerator().createElement(o);var m,p,n;for(m=1;m<arguments.length;m++){var l=arguments[m];if(!l){continue}if(typeof(l)=="string"||typeof(l)=="number"){q.appendChild(h.xmlTextNode(l))}else{if(typeof(l)=="object"&&typeof(l.sort)=="function"){for(p=0;p<l.length;p++){var j=l[p];if(typeof(j)=="object"&&typeof(j.sort)=="function"&&j[1]!==undefined){q.setAttribute(j[0],j[1])}}}else{if(typeof(l)=="object"){for(n in l){if(l.hasOwnProperty(n)){if(l[n]!==undefined){q.setAttribute(n,l[n])}}}}}}}return q},xmlescape:function(j){j=j.replace(/\&/g,"&amp;");j=j.replace(/</g,"&lt;");j=j.replace(/>/g,"&gt;");j=j.replace(/'/g,"&apos;");j=j.replace(/"/g,"&quot;");return j},xmlunescape:function(j){j=j.replace(/\&amp;/g,"&");j=j.replace(/&lt;/g,"<");j=j.replace(/&gt;/g,">");j=j.replace(/&apos;/g,"'");j=j.replace(/&quot;/g,'"');return j},xmlTextNode:function(j){return h.xmlGenerator().createTextNode(j)},xmlHtmlNode:function(j){var k;if(window.DOMParser){var l=new DOMParser();k=l.parseFromString(j,"text/xml")}else{k=new ActiveXObject("Microsoft.XMLDOM");k.async="false";k.loadXML(j)}return k},getText:function(k){if(!k){return null}var l="";if(k.childNodes.length===0&&k.nodeType==h.ElementType.TEXT){l+=k.nodeValue}for(var j=0;j<k.childNodes.length;j++){if(k.childNodes[j].nodeType==h.ElementType.TEXT){l+=k.childNodes[j].nodeValue}}return h.xmlescape(l)},copyElement:function(l){var j,k;if(l.nodeType==h.ElementType.NORMAL){k=h.xmlElement(l.tagName);for(j=0;j<l.attributes.length;j++){k.setAttribute(l.attributes[j].nodeName,l.attributes[j].value)}for(j=0;j<l.childNodes.length;j++){k.appendChild(h.copyElement(l.childNodes[j]))}}else{if(l.nodeType==h.ElementType.TEXT){k=h.xmlGenerator().createTextNode(l.nodeValue)}}return k},createHtml:function(m){var p,l,n,w,k,v,r,s,u,o,q;if(m.nodeType==h.ElementType.NORMAL){w=m.nodeName.toLowerCase();if(h.XHTML.validTag(w)){try{l=h.xmlElement(w);for(p=0;p<h.XHTML.attributes[w].length;p++){k=h.XHTML.attributes[w][p];v=m.getAttribute(k);if(typeof v=="undefined"||v===null||v===""||v===false||v===0){continue}if(k=="style"&&typeof v=="object"){if(typeof v.cssText!="undefined"){v=v.cssText}}if(k=="style"){r=[];s=v.split(";");for(n=0;n<s.length;n++){u=s[n].split(":");o=u[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase();if(h.XHTML.validCSS(o)){q=u[1].replace(/^\s*/,"").replace(/\s*$/,"");r.push(o+": "+q)}}if(r.length>0){v=r.join("; ");l.setAttribute(k,v)}}else{l.setAttribute(k,v)}}for(p=0;p<m.childNodes.length;p++){l.appendChild(h.createHtml(m.childNodes[p]))}}catch(t){l=h.xmlTextNode("")}}else{l=h.xmlGenerator().createDocumentFragment();for(p=0;p<m.childNodes.length;p++){l.appendChild(h.createHtml(m.childNodes[p]))}}}else{if(m.nodeType==h.ElementType.FRAGMENT){l=h.xmlGenerator().createDocumentFragment();for(p=0;p<m.childNodes.length;p++){l.appendChild(h.createHtml(m.childNodes[p]))}}else{if(m.nodeType==h.ElementType.TEXT){l=h.xmlTextNode(m.nodeValue)}}}return l},escapeNode:function(j){if(typeof j!=="string"){return j}return j.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(j){if(typeof j!=="string"){return j}return j.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(j){if(j.indexOf("@")<0){return null}return j.split("@")[0]},getDomainFromJid:function(j){var k=h.getBareJidFromJid(j);if(k.indexOf("@")<0){return k}else{var l=k.split("@");l.splice(0,1);return l.join("@")}},getResourceFromJid:function(j){var k=j.split("/");if(k.length<2){return null}k.splice(0,1);return k.join("/")},getBareJidFromJid:function(j){return j?j.split("/")[0]:null},log:function(k,j){return},debug:function(j){this.log(this.LogLevel.DEBUG,j)},info:function(j){this.log(this.LogLevel.INFO,j)},warn:function(j){this.log(this.LogLevel.WARN,j)},error:function(j){this.log(this.LogLevel.ERROR,j)},fatal:function(j){this.log(this.LogLevel.FATAL,j)},serialize:function(l){var j;if(!l){return null}if(typeof(l.tree)==="function"){l=l.tree()}var n=l.nodeName;var k,m;if(l.getAttribute("_realname")){n=l.getAttribute("_realname")}j="<"+n;for(k=0;k<l.attributes.length;k++){if(l.attributes[k].nodeName!="_realname"){j+=" "+l.attributes[k].nodeName+"='"+l.attributes[k].value.replace(/&/g,"&amp;").replace(/\'/g,"&apos;").replace(/>/g,"&gt;").replace(/</g,"&lt;")+"'"}}if(l.childNodes.length>0){j+=">";for(k=0;k<l.childNodes.length;k++){m=l.childNodes[k];switch(m.nodeType){case h.ElementType.NORMAL:j+=h.serialize(m);break;case h.ElementType.TEXT:j+=h.xmlescape(m.nodeValue);break;case h.ElementType.CDATA:j+="<![CDATA["+m.nodeValue+"]]>"}}j+="</"+n+">"}else{j+="/>"}return j},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(j,k){h._connectionPlugins[j]=k}};h.Builder=function(k,j){if(k=="presence"||k=="message"||k=="iq"){if(j&&!j.xmlns){j.xmlns=h.NS.CLIENT}else{if(!j){j={xmlns:h.NS.CLIENT}}}}this.nodeTree=h.xmlElement(k,j);this.node=this.nodeTree};h.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return h.serialize(this.nodeTree)},up:function(){this.node=this.node.parentNode;return this},attrs:function(l){for(var j in l){if(l.hasOwnProperty(j)){if(l[j]===undefined){this.node.removeAttribute(j)}else{this.node.setAttribute(j,l[j])}}}return this},c:function(k,j,l){var m=h.xmlElement(k,j,l);this.node.appendChild(m);if(typeof l!=="string"){this.node=m}return this},cnode:function(l){var k;var n=h.xmlGenerator();try{k=(n.importNode!==undefined)}catch(m){k=false}var j=k?n.importNode(l,true):h.copyElement(l);this.node.appendChild(j);this.node=j;return this},t:function(j){var k=h.xmlTextNode(j);this.node.appendChild(k);return this},h:function(k){var j=document.createElement("body");j.innerHTML=k;var l=h.createHtml(j);while(l.childNodes.length>0){this.node.appendChild(l.childNodes[0])}return this}};h.Handler=function(n,m,k,l,p,o,j){this.handler=n;this.ns=m;this.name=k;this.type=l;this.id=p;this.options=j||{matchBare:false};if(!this.options.matchBare){this.options.matchBare=false}if(this.options.matchBare){this.from=o?h.getBareJidFromJid(o):null}else{this.from=o}this.user=true};h.Handler.prototype={isMatch:function(l){var n;var m=null;if(this.options.matchBare){m=h.getBareJidFromJid(l.getAttribute("from"))}else{m=l.getAttribute("from")}n=false;if(!this.ns){n=true}else{var k=this;h.forEachChild(l,null,function(o){if(o.getAttribute("xmlns")==k.ns){n=true}});n=n||l.getAttribute("xmlns")==this.ns}var j=l.getAttribute("type");if(n&&(!this.name||h.isTagEqual(l,this.name))&&(!this.type||(Array.isArray(this.type)?this.type.indexOf(j)!=-1:j==this.type))&&(!this.id||l.getAttribute("id")==this.id)&&(!this.from||m==this.from)){return true}return false},run:function(k){var j=null;try{j=this.handler(k)}catch(l){if(l.sourceURL){h.fatal("error: "+this.handler+" "+l.sourceURL+":"+l.line+" - "+l.name+": "+l.message)}else{if(l.fileName){if(typeof(console)!="undefined"){console.trace();console.error(this.handler," - error - ",l,l.message)}h.fatal("error: "+this.handler+" "+l.fileName+":"+l.lineNumber+" - "+l.name+": "+l.message)}else{h.fatal("error: "+l.message+"\n"+l.stack)}}throw l}return j},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}};h.TimedHandler=function(k,j){this.period=k;this.handler=j;this.lastCalled=new Date().getTime();this.user=true};h.TimedHandler.prototype={run:function(){this.lastCalled=new Date().getTime();return this.handler()},reset:function(){this.lastCalled=new Date().getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}};h.Connection=function(j,m){this.service=j;this.options=m||{};var p=this.options.protocol||"";if(j.indexOf("ws:")===0||j.indexOf("wss:")===0||p.indexOf("ws")===0){this._proto=new h.Websocket(this)}else{this._proto=new h.Bosh(this)}this.jid="";this.domain=null;this.features=null;this._sasl_data={};this.do_session=false;this.do_bind=false;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._authentication={};this._idleTimeout=null;this._disconnectTimeout=null;this.authenticated=false;this.connected=false;this.disconnecting=false;this.do_authentication=true;this.paused=false;this.restored=false;this._data=[];this._uniqueId=0;this._sasl_success_handler=null;this._sasl_failure_handler=null;this._sasl_challenge_handler=null;this.maxRetries=5;this._idleTimeout=setTimeout(this._onIdle.stropheBind(this),100);for(var l in h._connectionPlugins){if(h._connectionPlugins.hasOwnProperty(l)){var o=h._connectionPlugins[l];var n=function(){};n.prototype=o;this[l]=new n();this[l].init(this)}}};h.Connection.prototype={reset:function(){this._proto._reset();this.do_session=false;this.do_bind=false;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._authentication={};this.authenticated=false;this.connected=false;this.disconnecting=false;this.restored=false;this._data=[];this._requests=[];this._uniqueId=0},pause:function(){this.paused=true},resume:function(){this.paused=false},getUniqueId:function(j){if(typeof(j)=="string"||typeof(j)=="number"){return ++this._uniqueId+":"+j}else{return ++this._uniqueId+""}},connect:function(l,m,p,o,n,j,k){this.jid=l;this.authzid=h.getBareJidFromJid(this.jid);this.authcid=k||h.getNodeFromJid(this.jid);this.pass=m;this.servtype="xmpp";this.connect_callback=p;this.disconnecting=false;this.connected=false;this.authenticated=false;this.restored=false;this.domain=h.getDomainFromJid(this.jid);this._changeConnectStatus(h.Status.CONNECTING,null);this._proto._connect(o,n,j)},attach:function(l,j,m,p,o,n,k){if(this._proto instanceof h.Bosh){this._proto._attach(l,j,m,p,o,n,k)}else{throw {name:"StropheSessionError",message:'The "attach" method can only be used with a BOSH connection.'}}},restore:function(k,n,m,l,j){if(this._sessionCachingSupported()){this._proto._restore(k,n,m,l,j)}else{throw {name:"StropheSessionError",message:'The "restore" method can only be used with a BOSH connection.'}}},_sessionCachingSupported:function(){if(this._proto instanceof h.Bosh){if(!JSON){return false}try{window.sessionStorage.setItem("_strophe_","_strophe_");window.sessionStorage.removeItem("_strophe_")}catch(j){return false}return true}return false},xmlInput:function(j){return},xmlOutput:function(j){return},rawInput:function(j){return},rawOutput:function(j){return},send:function(k){if(k===null){return}if(typeof(k.sort)==="function"){for(var j=0;j<k.length;j++){this._queueData(k[j])}}else{if(typeof(k.tree)==="function"){this._queueData(k.tree())}else{this._queueData(k)}}this._proto._send()},flush:function(){clearTimeout(this._idleTimeout);this._onIdle()},sendIQ:function(k,q,l,o){var s=null;var n=this;if(typeof(k.tree)==="function"){k=k.tree()}var j=k.getAttribute("id");if(!j){j=this.getUniqueId("sendIQ");k.setAttribute("id",j)}var m=k.getAttribute("to");var p=this.jid;var r=this.addHandler(function(v){if(s){n.deleteTimedHandler(s)}var t=false;var w=v.getAttribute("from");if(w===m||(m===null&&(w===h.getBareJidFromJid(p)||w===h.getDomainFromJid(p)||w===p))){t=true}if(!t){throw {name:"StropheError",message:"Got answer to IQ from wrong jid:"+w+"\nExpected jid: "+m}}var u=v.getAttribute("type");if(u=="result"){if(q){q(v)}}else{if(u=="error"){if(l){l(v)}}else{throw {name:"StropheError",message:"Got bad IQ type of "+u}}}},null,"iq",["error","result"],j);if(o){s=this.addTimedHandler(o,function(){n.deleteHandler(r);if(l){l(null)}return false})}this.send(k);return j},_queueData:function(j){if(j===null||!j.tagName||!j.childNodes){throw {name:"StropheError",message:"Cannot queue non-DOMElement."}}this._data.push(j)},_sendRestart:function(){this._data.push("restart");this._proto._sendRestart();this._idleTimeout=setTimeout(this._onIdle.stropheBind(this),100)},addTimedHandler:function(l,k){var j=new h.TimedHandler(l,k);this.addTimeds.push(j);return j},deleteTimedHandler:function(j){this.removeTimeds.push(j)},addHandler:function(o,n,l,m,q,p,k){var j=new h.Handler(o,n,l,m,q,p,k);this.addHandlers.push(j);return j},deleteHandler:function(j){this.removeHandlers.push(j);var k=this.addHandlers.indexOf(j);if(k>=0){this.addHandlers.splice(k,1)}},disconnect:function(j){this._changeConnectStatus(h.Status.DISCONNECTING,j);h.info("Disconnect was called because: "+j);if(this.connected){var k=false;this.disconnecting=true;if(this.authenticated){k=c({xmlns:h.NS.CLIENT,type:"unavailable"})}this._disconnectTimeout=this._addSysTimedHandler(3000,this._onDisconnectTimeout.stropheBind(this));this._proto._disconnect(k)}else{h.info("Disconnect was called before Strophe connected to the server");this._proto._abortAllRequests()}},_changeConnectStatus:function(j,p){for(var l in h._connectionPlugins){if(h._connectionPlugins.hasOwnProperty(l)){var n=this[l];if(n.statusChanged){try{n.statusChanged(j,p)}catch(m){h.error(""+l+" plugin caused an exception changing status: "+m)}}}}if(this.connect_callback){try{this.connect_callback(j,p)}catch(o){h.error("User connection callback caused an exception: "+o)}}},_doDisconnect:function(j){if(typeof this._idleTimeout=="number"){clearTimeout(this._idleTimeout)}if(this._disconnectTimeout!==null){this.deleteTimedHandler(this._disconnectTimeout);this._disconnectTimeout=null}h.info("_doDisconnect was called");this._proto._doDisconnect();this.authenticated=false;this.disconnecting=false;this.restored=false;this.handlers=[];this.timedHandlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._changeConnectStatus(h.Status.DISCONNECTED,j);this.connected=false},_dataRecv:function(q,r){h.info("_dataRecv called");var j=this._proto._reqToData(q);if(j===null){return}if(this.xmlInput!==h.Connection.prototype.xmlInput){if(j.nodeName===this._proto.strip&&j.childNodes.length){this.xmlInput(j.childNodes[0])}else{this.xmlInput(j)}}if(this.rawInput!==h.Connection.prototype.rawInput){if(r){this.rawInput(r)}else{this.rawInput(h.serialize(j))}}var m,k;while(this.removeHandlers.length>0){k=this.removeHandlers.pop();m=this.handlers.indexOf(k);if(m>=0){this.handlers.splice(m,1)}}while(this.addHandlers.length>0){this.handlers.push(this.addHandlers.pop())}if(this.disconnecting&&this._proto._emptyQueue()){this._doDisconnect();return}var o=j.getAttribute("type");var p,l;if(o!==null&&o=="terminate"){if(this.disconnecting){return}p=j.getAttribute("condition");l=j.getElementsByTagName("conflict");if(p!==null){if(p=="remote-stream-error"&&l.length>0){p="conflict"}this._changeConnectStatus(h.Status.CONNFAIL,p)}else{this._changeConnectStatus(h.Status.CONNFAIL,"unknown")}this._doDisconnect(p);return}var n=this;h.forEachChild(j,null,function(w){var t,u;u=n.handlers;n.handlers=[];for(t=0;t<u.length;t++){var s=u[t];try{if(s.isMatch(w)&&(n.authenticated||!s.user)){if(s.run(w)){n.handlers.push(s)}}else{n.handlers.push(s)}}catch(v){h.warn("Removing Strophe handlers due to uncaught exception: "+v.message)}}})},mechanisms:{},_connect_cb:function(q,t,r){h.info("_connect_cb was called");this.connected=true;var k=this._proto._reqToData(q);if(!k){return}if(this.xmlInput!==h.Connection.prototype.xmlInput){if(k.nodeName===this._proto.strip&&k.childNodes.length){this.xmlInput(k.childNodes[0])}else{this.xmlInput(k)}}if(this.rawInput!==h.Connection.prototype.rawInput){if(r){this.rawInput(r)}else{this.rawInput(h.serialize(k))}}var l=this._proto._connect_cb(k);if(l===h.Status.CONNFAIL){return}this._authentication.sasl_scram_sha1=false;this._authentication.sasl_plain=false;this._authentication.sasl_digest_md5=false;this._authentication.sasl_anonymous=false;this._authentication.legacy_auth=false;var n;if(k.getElementsByTagNameNS){n=k.getElementsByTagNameNS(h.NS.STREAM,"features").length>0}else{n=k.getElementsByTagName("stream:features").length>0||k.getElementsByTagName("features").length>0}var s=k.getElementsByTagName("mechanism");var j=[];var m,o,p=false;if(!n){this._proto._no_auth_received(t);return}if(s.length>0){for(m=0;m<s.length;m++){o=h.getText(s[m]);if(this.mechanisms[o]){j.push(this.mechanisms[o])}}}this._authentication.legacy_auth=k.getElementsByTagName("auth").length>0;p=this._authentication.legacy_auth||j.length>0;if(!p){this._proto._no_auth_received(t);return}if(this.do_authentication!==false){this.authenticate(j)}},authenticate:function(l){var o;for(o=0;o<l.length-1;++o){var k=o;for(var n=o+1;n<l.length;++n){if(l[n].prototype.priority>l[k].prototype.priority){k=n}}if(k!=o){var q=l[o];l[o]=l[k];l[k]=q}}var p=false;for(o=0;o<l.length;++o){if(!l[o].test(this)){continue}this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.stropheBind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.stropheBind(this),null,"failure",null,null);this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge_cb.stropheBind(this),null,"challenge",null,null);this._sasl_mechanism=new l[o]();this._sasl_mechanism.onStart(this);var r=f("auth",{xmlns:h.NS.SASL,mechanism:this._sasl_mechanism.name});if(this._sasl_mechanism.isClientFirst){var m=this._sasl_mechanism.onChallenge(this,null);r.t(i.encode(m))}this.send(r.tree());p=true;break}if(!p){if(h.getNodeFromJid(this.jid)===null){this._changeConnectStatus(h.Status.CONNFAIL,"x-strophe-bad-non-anon-jid");this.disconnect("x-strophe-bad-non-anon-jid")}else{this._changeConnectStatus(h.Status.AUTHENTICATING,null);this._addSysHandler(this._auth1_cb.stropheBind(this),null,null,null,"_auth_1");this.send(g({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:h.NS.AUTH}).c("username",{}).t(h.getNodeFromJid(this.jid)).tree())}}},_sasl_challenge_cb:function(l){var k=i.decode(h.getText(l));var j=this._sasl_mechanism.onChallenge(this,k);var m=f("response",{xmlns:h.NS.SASL});if(j!==""){m.t(i.encode(j))}this.send(m.tree());return true},_auth1_cb:function(j){var k=g({type:"set",id:"_auth_2"}).c("query",{xmlns:h.NS.AUTH}).c("username",{}).t(h.getNodeFromJid(this.jid)).up().c("password").t(this.pass);if(!h.getResourceFromJid(this.jid)){this.jid=h.getBareJidFromJid(this.jid)+"/strophe"}k.up().c("resource",{}).t(h.getResourceFromJid(this.jid));this._addSysHandler(this._auth2_cb.stropheBind(this),null,null,null,"_auth_2");this.send(k.tree());return false},_sasl_success_cb:function(l){if(this._sasl_data["server-signature"]){var j;var o=i.decode(h.getText(l));var n=/([a-z]+)=([^,]+)(,|$)/;var m=o.match(n);if(m[1]=="v"){j=m[2]}if(j!=this._sasl_data["server-signature"]){this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);this._sasl_challenge_handler=null}this._sasl_data={};return this._sasl_failure_cb(null)}}h.info("SASL authentication succeeded.");if(this._sasl_mechanism){this._sasl_mechanism.onSuccess()}this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);this._sasl_challenge_handler=null}var k=[];var p=function(q,r){while(q.length){this.deleteHandler(q.pop())}this._sasl_auth1_cb.stropheBind(this)(r);return false};k.push(this._addSysHandler(function(q){p.stropheBind(this)(k,q)}.stropheBind(this),null,"stream:features",null,null));k.push(this._addSysHandler(function(q){p.stropheBind(this)(k,q)}.stropheBind(this),h.NS.STREAM,"features",null,null));this._sendRestart();return false},_sasl_auth1_cb:function(k){this.features=k;var j,m;for(j=0;j<k.childNodes.length;j++){m=k.childNodes[j];if(m.nodeName=="bind"){this.do_bind=true}if(m.nodeName=="session"){this.do_session=true}}if(!this.do_bind){this._changeConnectStatus(h.Status.AUTHFAIL,null);return false}else{this._addSysHandler(this._sasl_bind_cb.stropheBind(this),null,null,null,"_bind_auth_2");var l=h.getResourceFromJid(this.jid);if(l){this.send(g({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:h.NS.BIND}).c("resource",{}).t(l).tree())}else{this.send(g({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:h.NS.BIND}).tree())}}return false},_sasl_bind_cb:function(j){if(j.getAttribute("type")=="error"){h.info("SASL binding failed.");var k=j.getElementsByTagName("conflict"),n;if(k.length>0){n="conflict"}this._changeConnectStatus(h.Status.AUTHFAIL,n);return false}var m=j.getElementsByTagName("bind");var l;if(m.length>0){l=m[0].getElementsByTagName("jid");if(l.length>0){this.jid=h.getText(l[0]);if(this.do_session){this._addSysHandler(this._sasl_session_cb.stropheBind(this),null,null,null,"_session_auth_2");this.send(g({type:"set",id:"_session_auth_2"}).c("session",{xmlns:h.NS.SESSION}).tree())}else{this.authenticated=true;this._changeConnectStatus(h.Status.CONNECTED,null)}}}else{h.info("SASL binding failed.");this._changeConnectStatus(h.Status.AUTHFAIL,null);return false}},_sasl_session_cb:function(j){if(j.getAttribute("type")=="result"){this.authenticated=true;this._changeConnectStatus(h.Status.CONNECTED,null)}else{if(j.getAttribute("type")=="error"){h.info("Session creation failed.");this._changeConnectStatus(h.Status.AUTHFAIL,null);return false}}return false},_sasl_failure_cb:function(j){if(this._sasl_success_handler){this.deleteHandler(this._sasl_success_handler);this._sasl_success_handler=null}if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);this._sasl_challenge_handler=null}if(this._sasl_mechanism){this._sasl_mechanism.onFailure()}this._changeConnectStatus(h.Status.AUTHFAIL,null);return false},_auth2_cb:function(j){if(j.getAttribute("type")=="result"){this.authenticated=true;this._changeConnectStatus(h.Status.CONNECTED,null)}else{if(j.getAttribute("type")=="error"){this._changeConnectStatus(h.Status.AUTHFAIL,null);this.disconnect("authentication failed")}}return false},_addSysTimedHandler:function(l,k){var j=new h.TimedHandler(l,k);j.user=false;this.addTimeds.push(j);return j},_addSysHandler:function(n,m,k,l,o){var j=new h.Handler(n,m,k,l,o);j.user=false;this.addHandlers.push(j);return j},_onDisconnectTimeout:function(){h.info("_onDisconnectTimeout was called");this._proto._onDisconnectTimeout();this._doDisconnect();return false},_onIdle:function(){var k,m,n,l;while(this.addTimeds.length>0){this.timedHandlers.push(this.addTimeds.pop())}while(this.removeTimeds.length>0){m=this.removeTimeds.pop();k=this.timedHandlers.indexOf(m);if(k>=0){this.timedHandlers.splice(k,1)}}var j=new Date().getTime();l=[];for(k=0;k<this.timedHandlers.length;k++){m=this.timedHandlers[k];if(this.authenticated||!m.user){n=m.lastCalled+m.period;if(n-j<=0){if(m.run()){l.push(m)}}else{l.push(m)}}}this.timedHandlers=l;clearTimeout(this._idleTimeout);this._proto._onIdle();if(this.connected){this._idleTimeout=setTimeout(this._onIdle.stropheBind(this),100)}}};h.SASLMechanism=function(j,l,k){this.name=j;this.isClientFirst=l;this.priority=k};h.SASLMechanism.prototype={test:function(j){return true},onStart:function(j){this._connection=j},onChallenge:function(j,k){throw new Error("You should implement challenge handling!")},onFailure:function(){this._connection=null},onSuccess:function(){this._connection=null}};h.SASLAnonymous=function(){};h.SASLAnonymous.prototype=new h.SASLMechanism("ANONYMOUS",false,10);h.SASLAnonymous.test=function(j){return j.authcid===null};h.Connection.prototype.mechanisms[h.SASLAnonymous.prototype.name]=h.SASLAnonymous;h.SASLPlain=function(){};h.SASLPlain.prototype=new h.SASLMechanism("PLAIN",true,20);h.SASLPlain.test=function(j){return j.authcid!==null};h.SASLPlain.prototype.onChallenge=function(k){var j=k.authzid;j=j+"\u0000";j=j+k.authcid;j=j+"\u0000";j=j+k.pass;return j};h.Connection.prototype.mechanisms[h.SASLPlain.prototype.name]=h.SASLPlain;h.SASLSHA1=function(){};h.SASLSHA1.prototype=new h.SASLMechanism("SCRAM-SHA-1",true,40);h.SASLSHA1.test=function(j){return j.authcid!==null};h.SASLSHA1.prototype.onChallenge=function(k,l,m){var n=m||d.hexdigest(Math.random()*1234567890);var j="n="+k.authcid;j+=",r=";j+=n;k._sasl_data.cnonce=n;k._sasl_data["client-first-message-bare"]=j;j="n,,"+j;this.onChallenge=function(w,F){var D,q,A,t,r,y,B,z;var o,x,C;var v="c=biws,";var u=w._sasl_data["client-first-message-bare"]+","+F+",";var E=w._sasl_data.cnonce;var s=/([a-z]+)=([^,]+)(,|$)/;while(F.match(s)){var p=F.match(s);F=F.replace(p[0],"");switch(p[1]){case"r":D=p[2];break;case"s":q=p[2];break;case"i":A=p[2];break}}if(D.substr(0,E.length)!==E){w._sasl_data={};return w._sasl_failure_cb()}v+="r="+D;u+=v;q=i.decode(q);q+="\x00\x00\x00\x01";t=y=e.core_hmac_sha1(w.pass,q);for(B=1;B<A;B++){r=e.core_hmac_sha1(w.pass,e.binb2str(y));for(z=0;z<5;z++){t[z]^=r[z]}y=r}t=e.binb2str(t);o=e.core_hmac_sha1(t,"Client Key");x=e.str_hmac_sha1(t,"Server Key");C=e.core_hmac_sha1(e.str_sha1(e.binb2str(o)),u);w._sasl_data["server-signature"]=e.b64_hmac_sha1(x,u);for(z=0;z<5;z++){o[z]^=C[z]}v+=",p="+i.encode(e.binb2str(o));return v}.stropheBind(this);return j};h.Connection.prototype.mechanisms[h.SASLSHA1.prototype.name]=h.SASLSHA1;h.SASLMD5=function(){};h.SASLMD5.prototype=new h.SASLMechanism("DIGEST-MD5",false,30);h.SASLMD5.test=function(j){return j.authcid!==null};h.SASLMD5.prototype._quote=function(j){return'"'+j.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'};h.SASLMD5.prototype.onChallenge=function(k,u,q){var l=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/;var v=q||d.hexdigest(""+(Math.random()*1234567890));var r="";var w=null;var s="";var j="";var p;while(u.match(l)){p=u.match(l);u=u.replace(p[0],"");p[2]=p[2].replace(/^"(.+)"$/,"$1");switch(p[1]){case"realm":r=p[2];break;case"nonce":s=p[2];break;case"qop":j=p[2];break;case"host":w=p[2];break}}var o=k.servtype+"/"+k.domain;if(w!==null){o=o+"/"+w}var n=d.hash(k.authcid+":"+r+":"+this._connection.pass)+":"+s+":"+v;var m="AUTHENTICATE:"+o;var t="";t+="charset=utf-8,";t+="username="+this._quote(k.authcid)+",";t+="realm="+this._quote(r)+",";t+="nonce="+this._quote(s)+",";t+="nc=00000001,";t+="cnonce="+this._quote(v)+",";t+="digest-uri="+this._quote(o)+",";t+="response="+d.hexdigest(d.hexdigest(n)+":"+s+":00000001:"+v+":auth:"+d.hexdigest(m))+",";t+="qop=auth";this.onChallenge=function(){return""}.stropheBind(this);return t};h.Connection.prototype.mechanisms[h.SASLMD5.prototype.name]=h.SASLMD5;return{Strophe:h,$build:f,$msg:b,$iq:g,$pres:c,SHA1:e,Base64:i,MD5:d}}));(function(b,c){if(typeof define==="function"&&define.amd){define("strophe-bosh",["strophe-core"],function(d){return c(d.Strophe,d.$build)})}else{return c(Strophe,$build)}}(this,function(d,c){d.Request=function(g,f,e,h){this.id=++d._requestId;this.xmlData=g;this.data=d.serialize(g);this.origFunc=f;this.func=f;this.rid=e;this.date=NaN;this.sends=h||0;this.abort=false;this.dead=null;this.age=function(){if(!this.date){return 0}var i=new Date();return(i-this.date)/1000};this.timeDead=function(){if(!this.dead){return 0}var i=new Date();return(i-this.dead)/1000};this.xhr=this._newXHR()};d.Request.prototype={getResponse:function(){var e=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){e=this.xhr.responseXML.documentElement;if(e.tagName=="parsererror"){d.error("invalid response received");d.error("responseText: "+this.xhr.responseText);d.error("responseXML: "+d.serialize(this.xhr.responseXML));throw"parsererror"}}else{if(this.xhr.responseText){d.error("invalid response received");d.error("responseText: "+this.xhr.responseText);d.error("responseXML: "+d.serialize(this.xhr.responseXML))}}return e},_newXHR:function(){var e=null;if(window.XMLHttpRequest){e=new XMLHttpRequest();if(e.overrideMimeType){e.overrideMimeType("text/xml; charset=utf-8")}}else{if(window.ActiveXObject){e=new ActiveXObject("Microsoft.XMLHTTP")}}e.onreadystatechange=this.func.stropheBind(null,this);return e}};d.Bosh=function(e){this._conn=e;this.rid=Math.floor(Math.random()*4294967295);this.sid=null;this.hold=1;this.wait=60;this.window=5;this.errors=0;this._requests=[]};d.Bosh.prototype={strip:null,_buildBody:function(){var e=c("body",{rid:this.rid++,xmlns:d.NS.HTTPBIND});if(this.sid!==null){e.attrs({sid:this.sid})}if(this._conn.options.keepalive){this._cacheSession()}return e},_reset:function(){this.rid=Math.floor(Math.random()*4294967295);this.sid=null;this.errors=0;window.sessionStorage.removeItem("strophe-bosh-session")},_connect:function(i,h,f){this.wait=i||this.wait;this.hold=h||this.hold;this.errors=0;var e=this._buildBody().attrs({to:this._conn.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":d.NS.BOSH});if(f){e.attrs({route:f})}var g=this._conn._connect_cb;this._requests.push(new d.Request(e.tree(),this._onRequestStateChange.stropheBind(this,g.stropheBind(this._conn)),e.tree().getAttribute("rid")));this._throttledRequestHandler()},_attach:function(g,e,h,k,j,i,f){this._conn.jid=g;this.sid=e;this.rid=h;this._conn.connect_callback=k;this._conn.domain=d.getDomainFromJid(this._conn.jid);this._conn.authenticated=true;this._conn.connected=true;this.wait=j||this.wait;this.hold=i||this.hold;this.window=f||this.window;this._conn._changeConnectStatus(d.Status.ATTACHED,null)},_restore:function(f,j,i,h,e){var g=JSON.parse(window.sessionStorage.getItem("strophe-bosh-session"));if(typeof g!=="undefined"&&g!==null&&g.rid&&g.sid&&g.jid&&(typeof f==="undefined"||d.getBareJidFromJid(g.jid)==d.getBareJidFromJid(f))){this._conn.restored=true;this._attach(g.jid,g.sid,g.rid,j,i,h,e)}else{throw {name:"StropheSessionError",message:"_restore: no restoreable session."}}},_cacheSession:function(){if(this._conn.authenticated){if(this._conn.jid&&this.rid&&this.sid){window.sessionStorage.setItem("strophe-bosh-session",JSON.stringify({jid:this._conn.jid,rid:this.rid,sid:this.sid}))}}else{window.sessionStorage.removeItem("strophe-bosh-session")}},_connect_cb:function(f){var h=f.getAttribute("type");var g,i;if(h!==null&&h=="terminate"){g=f.getAttribute("condition");d.error("BOSH-Connection failed: "+g);i=f.getElementsByTagName("conflict");if(g!==null){if(g=="remote-stream-error"&&i.length>0){g="conflict"}this._conn._changeConnectStatus(d.Status.CONNFAIL,g)}else{this._conn._changeConnectStatus(d.Status.CONNFAIL,"unknown")}this._conn._doDisconnect(g);return d.Status.CONNFAIL}if(!this.sid){this.sid=f.getAttribute("sid")}var e=f.getAttribute("requests");if(e){this.window=parseInt(e,10)}var k=f.getAttribute("hold");if(k){this.hold=parseInt(k,10)}var j=f.getAttribute("wait");if(j){this.wait=parseInt(j,10)}},_disconnect:function(e){this._sendTerminate(e)},_doDisconnect:function(){this.sid=null;this.rid=Math.floor(Math.random()*4294967295);window.sessionStorage.removeItem("strophe-bosh-session")},_emptyQueue:function(){return this._requests.length===0},_hitError:function(e){this.errors++;d.warn("request errored, status: "+e+", number of errors: "+this.errors);if(this.errors>4){this._conn._onDisconnectTimeout()}},_no_auth_received:function(f){if(f){f=f.stropheBind(this._conn)}else{f=this._conn._connect_cb.stropheBind(this._conn)}var e=this._buildBody();this._requests.push(new d.Request(e.tree(),this._onRequestStateChange.stropheBind(this,f.stropheBind(this._conn)),e.tree().getAttribute("rid")));this._throttledRequestHandler()},_onDisconnectTimeout:function(){this._abortAllRequests()},_abortAllRequests:function b(){var e;while(this._requests.length>0){e=this._requests.pop();e.abort=true;e.xhr.abort();e.xhr.onreadystatechange=function(){}}},_onIdle:function(){var g=this._conn._data;if(this._conn.authenticated&&this._requests.length===0&&g.length===0&&!this._conn.disconnecting){d.info("no requests during idle cycle, sending blank request");g.push(null)}if(this._conn.paused){return}if(this._requests.length<2&&g.length>0){var e=this._buildBody();for(var f=0;f<g.length;f++){if(g[f]!==null){if(g[f]==="restart"){e.attrs({to:this._conn.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":d.NS.BOSH})}else{e.cnode(g[f]).up()}}}delete this._conn._data;this._conn._data=[];this._requests.push(new d.Request(e.tree(),this._onRequestStateChange.stropheBind(this,this._conn._dataRecv.stropheBind(this._conn)),e.tree().getAttribute("rid")));this._throttledRequestHandler()}if(this._requests.length>0){var h=this._requests[0].age();if(this._requests[0].dead!==null){if(this._requests[0].timeDead()>Math.floor(d.SECONDARY_TIMEOUT*this.wait)){this._throttledRequestHandler()}}if(h>Math.floor(d.TIMEOUT*this.wait)){d.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(d.TIMEOUT*this.wait)+" seconds since last activity");this._throttledRequestHandler()}}},_onRequestStateChange:function(i,h){d.debug("request id "+h.id+"."+h.sends+" state changed to "+h.xhr.readyState);if(h.abort){h.abort=false;return}var g;if(h.xhr.readyState==4){g=0;try{g=h.xhr.status}catch(j){}if(typeof(g)=="undefined"){g=0}if(this.disconnecting){if(g>=400){this._hitError(g);return}}var f=(this._requests[0]==h);var k=(this._requests[1]==h);if((g>0&&g<500)||h.sends>5){this._removeRequest(h);d.debug("request id "+h.id+" should now be removed")}if(g==200){if(k||(f&&this._requests.length>0&&this._requests[0].age()>Math.floor(d.SECONDARY_TIMEOUT*this.wait))){this._restartRequest(0)}d.debug("request id "+h.id+"."+h.sends+" got 200");i(h);this.errors=0}else{d.error("request id "+h.id+"."+h.sends+" error "+g+" happened");if(g===0||(g>=400&&g<600)||g>=12000){this._hitError(g);if(g>=400&&g<500){this._conn._changeConnectStatus(d.Status.DISCONNECTING,null);this._conn._doDisconnect()}}}if(!((g>0&&g<500)||h.sends>5)){this._throttledRequestHandler()}}},_processRequest:function(h){var r=this;var n=this._requests[h];var q=-1;try{if(n.xhr.readyState==4){q=n.xhr.status}}catch(l){d.error("caught an error in _requests["+h+"], reqStatus: "+q)}if(typeof(q)=="undefined"){q=-1}if(n.sends>this._conn.maxRetries){this._conn._onDisconnectTimeout();return}var g=n.age();var f=(!isNaN(g)&&g>Math.floor(d.TIMEOUT*this.wait));var j=(n.dead!==null&&n.timeDead()>Math.floor(d.SECONDARY_TIMEOUT*this.wait));var p=(n.xhr.readyState==4&&(q<1||q>=500));if(f||j||p){if(j){d.error("Request "+this._requests[h].id+" timed out (secondary), restarting")}n.abort=true;n.xhr.abort();n.xhr.onreadystatechange=function(){};this._requests[h]=new d.Request(n.xmlData,n.origFunc,n.rid,n.sends);n=this._requests[h]}if(n.xhr.readyState===0){d.debug("request id "+n.id+"."+n.sends+" posting");try{n.xhr.open("POST",this._conn.service,this._conn.options.sync?false:true);n.xhr.setRequestHeader&&n.xhr.setRequestHeader("Content-Type","text/xml; charset=utf-8")}catch(m){d.error("XHR open failed.");if(!this._conn.connected){this._conn._changeConnectStatus(d.Status.CONNFAIL,"bad-service")}this._conn.disconnect();return}var o=function(){n.date=new Date();if(r._conn.options.customHeaders){var e=r._conn.options.customHeaders;for(var i in e){if(e.hasOwnProperty(i)){n.xhr.setRequestHeader(i,e[i])}}}n.xhr.send(n.data)};if(n.sends>1){var k=Math.min(Math.floor(d.TIMEOUT*this.wait),Math.pow(n.sends,3))*1000;setTimeout(o,k)}else{o()}n.sends++;if(this._conn.xmlOutput!==d.Connection.prototype.xmlOutput){if(n.xmlData.nodeName===this.strip&&n.xmlData.childNodes.length){this._conn.xmlOutput(n.xmlData.childNodes[0])}else{this._conn.xmlOutput(n.xmlData)}}if(this._conn.rawOutput!==d.Connection.prototype.rawOutput){this._conn.rawOutput(n.data)}}else{d.debug("_processRequest: "+(h===0?"first":"second")+" request has readyState of "+n.xhr.readyState)}},_removeRequest:function(f){d.debug("removing request");var e;for(e=this._requests.length-1;e>=0;e--){if(f==this._requests[e]){this._requests.splice(e,1)}}f.xhr.onreadystatechange=function(){};this._throttledRequestHandler()},_restartRequest:function(e){var f=this._requests[e];if(f.dead===null){f.dead=new Date()}this._processRequest(e)},_reqToData:function(f){try{return f.getResponse()}catch(g){if(g!="parsererror"){throw g}this._conn.disconnect("strophe-parsererror")}},_sendTerminate:function(g){d.info("_sendTerminate was called");var e=this._buildBody().attrs({type:"terminate"});if(g){e.cnode(g.tree())}var f=new d.Request(e.tree(),this._onRequestStateChange.stropheBind(this,this._conn._dataRecv.stropheBind(this._conn)),e.tree().getAttribute("rid"));this._requests.push(f);this._throttledRequestHandler()},_send:function(){clearTimeout(this._conn._idleTimeout);this._throttledRequestHandler();this._conn._idleTimeout=setTimeout(this._conn._onIdle.stropheBind(this._conn),100)},_sendRestart:function(){this._throttledRequestHandler();clearTimeout(this._conn._idleTimeout)},_throttledRequestHandler:function(){if(!this._requests){d.debug("_throttledRequestHandler called with undefined requests")}else{d.debug("_throttledRequestHandler called with "+this._requests.length+" requests")}if(!this._requests||this._requests.length===0){return}if(this._requests.length>0){this._processRequest(0)}if(this._requests.length>1&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window){this._processRequest(1)}}};return d}));(function(b,c){if(typeof define==="function"&&define.amd){define("strophe-websocket",["strophe-core"],function(d){return c(d.Strophe,d.$build)})}else{return c(Strophe,$build)}}(this,function(c,b){c.Websocket=function(f){this._conn=f;this.strip="wrapper";var d=f.service;if(d.indexOf("ws:")!==0&&d.indexOf("wss:")!==0){var e="";if(f.options.protocol==="ws"&&window.location.protocol!=="https:"){e+="ws"}else{e+="wss"}e+="://"+window.location.host;if(d.indexOf("/")!==0){e+=window.location.pathname+d}else{e+=d}f.service=e}};c.Websocket.prototype={_buildStream:function(){return b("open",{xmlns:c.NS.FRAMING,to:this._conn.domain,version:"1.0"})},_check_streamerror:function(d,k){var n;if(d.getElementsByTagNameNS){n=d.getElementsByTagNameNS(c.NS.STREAM,"error")}else{n=d.getElementsByTagName("stream:error")}if(n.length===0){return false}var l=n[0];var f="";var o="";var m="urn:ietf:params:xml:ns:xmpp-streams";for(var h=0;h<l.childNodes.length;h++){var j=l.childNodes[h];if(j.getAttribute("xmlns")!==m){break}if(j.nodeName==="text"){o=j.textContent}else{f=j.nodeName}}var g="WebSocket stream error: ";if(f){g+=f}else{g+="unknown"}if(o){g+=" - "+f}c.error(g);this._conn._changeConnectStatus(k,f);this._conn._doDisconnect();return true},_reset:function(){return},_connect:function(){this._closeSocket();this.socket=new WebSocket(this._conn.service,"xmpp");this.socket.onopen=this._onOpen.stropheBind(this);this.socket.onerror=this._onError.stropheBind(this);this.socket.onclose=this._onClose.stropheBind(this);this.socket.onmessage=this._connect_cb_wrapper.stropheBind(this)},_connect_cb:function(e){var d=this._check_streamerror(e,c.Status.CONNFAIL);if(d){return c.Status.CONNFAIL}},_handleStreamStart:function(g){var e=false;var f=g.getAttribute("xmlns");if(typeof f!=="string"){e="Missing xmlns in <open />"}else{if(f!==c.NS.FRAMING){e="Wrong xmlns in <open />: "+f}}var d=g.getAttribute("version");if(typeof d!=="string"){e="Missing version in <open />"}else{if(d!=="1.0"){e="Wrong version in <open />: "+d}}if(e){this._conn._changeConnectStatus(c.Status.CONNFAIL,e);this._conn._doDisconnect();return false}return true},_connect_cb_wrapper:function(h){if(h.data.indexOf("<open ")===0||h.data.indexOf("<?xml")===0){var i=h.data.replace(/^(<\?.*?\?>\s*)*/,"");if(i===""){return}var f=new DOMParser().parseFromString(i,"text/xml").documentElement;this._conn.xmlInput(f);this._conn.rawInput(h.data);if(this._handleStreamStart(f)){this._connect_cb(f)}}else{if(h.data.indexOf("<close ")===0){this._conn.rawInput(h.data);this._conn.xmlInput(h);var d=h.getAttribute("see-other-uri");if(d){this._conn._changeConnectStatus(c.Status.REDIRECT,"Received see-other-uri, resetting connection");this._conn.reset();this._conn.service=d;this._connect()}else{this._conn._changeConnectStatus(c.Status.CONNFAIL,"Received closing stream");this._conn._doDisconnect()}}else{var e=this._streamWrap(h.data);var g=new DOMParser().parseFromString(e,"text/xml").documentElement;this.socket.onmessage=this._onMessage.stropheBind(this);this._conn._connect_cb(g,null,h.data)}}},_disconnect:function(h){if(this.socket&&this.socket.readyState!==WebSocket.CLOSED){if(h){this._conn.send(h)}var g=b("close",{xmlns:c.NS.FRAMING});this._conn.xmlOutput(g);var d=c.serialize(g);this._conn.rawOutput(d);try{this.socket.send(d)}catch(f){c.info("Couldn't send <close /> tag.")}}this._conn._doDisconnect()},_doDisconnect:function(){c.info("WebSockets _doDisconnect was called");this._closeSocket()},_streamWrap:function(d){return"<wrapper>"+d+"</wrapper>"},_closeSocket:function(){if(this.socket){try{this.socket.close()}catch(d){}}this.socket=null},_emptyQueue:function(){return true},_onClose:function(){if(this._conn.connected&&!this._conn.disconnecting){c.error("Websocket closed unexcectedly");this._conn._doDisconnect()}else{c.info("Websocket closed")}},_no_auth_received:function(d){c.error("Server did not send any auth methods");this._conn._changeConnectStatus(c.Status.CONNFAIL,"Server did not send any auth methods");if(d){d=d.stropheBind(this._conn);d()}this._conn._doDisconnect()},_onDisconnectTimeout:function(){},_abortAllRequests:function(){},_onError:function(d){c.error("Websocket error "+d);this._conn._changeConnectStatus(c.Status.CONNFAIL,"The WebSocket connection could not be established was disconnected.");this._disconnect()},_onIdle:function(){var e=this._conn._data;if(e.length>0&&!this._conn.paused){for(var d=0;d<e.length;d++){if(e[d]!==null){var f,g;if(e[d]==="restart"){f=this._buildStream().tree()}else{f=e[d]}g=c.serialize(f);this._conn.xmlOutput(f);this._conn.rawOutput(g);this.socket.send(g)}}this._conn._data=[]}},_onMessage:function(e){var d,f;var g='<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />';if(e.data===g){this._conn.rawInput(g);this._conn.xmlInput(e);if(!this._conn.disconnecting){this._conn._doDisconnect()}return}else{if(e.data.search("<open ")===0){d=new DOMParser().parseFromString(e.data,"text/xml").documentElement;if(!this._handleStreamStart(d)){return}}else{f=this._streamWrap(e.data);d=new DOMParser().parseFromString(f,"text/xml").documentElement}}if(this._check_streamerror(d,c.Status.ERROR)){return}if(this._conn.disconnecting&&d.firstChild.nodeName==="presence"&&d.firstChild.getAttribute("type")==="unavailable"){this._conn.xmlInput(d);this._conn.rawInput(c.serialize(d));return}this._conn._dataRecv(d,e.data)},_onOpen:function(){c.info("Websocket open");var e=this._buildStream();this._conn.xmlOutput(e.tree());var d=c.serialize(e);this._conn.rawOutput(d);this.socket.send(d)},_reqToData:function(d){return d},_send:function(){this._conn.flush()},_sendRestart:function(){clearTimeout(this._conn._idleTimeout);this._conn._onIdle.stropheBind(this._conn)()}};return c}));if(a){return a(Strophe,$build,$msg,$iq,$pres)}})(function(b,e,d,a,c){window.Strophe=b;window.$build=e;window.$msg=d;window.$iq=a;window.$pres=c});